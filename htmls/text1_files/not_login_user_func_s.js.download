//
var defineNotLoginParams = {
	contentId:'',
	contentTypeId:'',
	pathAjaxRecommend:'',
	pathContentRelation:'',
	view:'',
	engine:'p',
	from:''
};

function initNotLoginUserFunc(argv){
	defineNotLoginParams = argv;

	// 創作ツリー 左上アイコンと作品下ボタン
	$('._btn_tree').click(function() {
		window.open(defineNotLoginParams['pathContentRelation'], 'popup_relation', 'toolbar=no,location=no,status=yes,menubar=no,scrollbars=yes,resizable=no,width=510,height=770');
		return false;
	});

	// 折りたたみの追加説明文
	$('.popup-more').on('click', function(){
		var selector = "#"+$(this).data('target');
		var editDiv = "#"+$(this).data('edit');
		var height = parseInt($(this).data('height'));
		$(selector).toggle(100);
		var baseHeight = parseInt($('#colorbox').css('height'));
		var icon = $(this).find('i');
		var text = $(this).find('span');
		if( icon.hasClass('fa-plus-square-o') == true){
			adjustColorbox(editDiv, (baseHeight+height));
			text.html('表示を折りたたむ');
		}else{
			adjustColorbox(editDiv, (baseHeight-height));
			text.html('詳しく表示');
		}
		icon.toggleClass('fa-plus-square-o fa-minus-square-o');
		return false;
	});

	// オリジナルライセンス変更履歴折りたたみ
	$('#_orgpc_hist_link').click(function() {
		$('#_orgpc_hist').slideToggle(100);
		var icon = $(this).find('i');
		icon.toggleClass('fa-plus-square-o fa-minus-square-o');
		return false;
	});

	//  …メニューのON/OFF
	$('#a_more_menu').on('click', function () {
		$('#ul_more_menu').slideToggle(100);
		return false;
	});

	//  投稿者プロフィールの開閉
	$('#content_detail_userbar_more').on('click', function () {
		var p = $('#content_detail_userbar_more').parent();
		var s = $('#content_detail_userbar_more > span');
		if( p.hasClass('expand') === false) {
			p.addClass('expand');
			s.text('閉じる');
		}else{
			p.removeClass('expand');
			s.text('もっと見る');
		}
		return false;
	});

	//  創作ツリーを開く
	$('#a_relation_tree').on('click', function() {
		window.open(defineNotLoginParams['pathContentRelation'], 'popup_relation', 'toolbar=no,location=no,status=yes,menubar=no,scrollbars=yes,resizable=no,width=510,height=770');
		return false;
	});

	$('#recommendMoreTitle').on('click', function(){
		recommendMore();
		return false;
	});
}

function adjustColorbox(target, height){
	$('#colorbox').css('height', height.toString()+'px');
	$('#cboxWrapper').css('height', height.toString()+'px');
	$('#cboxContent').css('height', height.toString()+'px');
	$('#cboxLoadedContent').css('height', height.toString()+'px');
	if( target !== null ){
		$(target).css('height', height.toString()+'px');
	}
}

//	おすすめ情報をもっとみる
var processingRecommendMore = false;
function recommendMore(){
	if( processingRecommendMore === false){
		$('#recommendMoreTitle').html('<i class="fa fa-spin fa-spinner" style="font-size:1.5em;"></i>&nbsp;読み込み中');
		processingRecommendMore = true;
		getRecommendMore();
	}
	return false;
}
function getRecommendMore(){
	var span = $('#spanRecommendContentCount');
	var more = $('#recommendMoreTitle');
	var now = parseInt(span.html());
	var url = defineNotLoginParams['pathAjaxRecommend']+'?c='+defineNotLoginParams['contentId']+'&t='+defineNotLoginParams['contentTypeId']+'&s='+now+'&e='+defineNotLoginParams['engine']+'&f='+defineNotLoginParams['from'];
	$.ajax({
		url: url,
		dataType: "json",
		cache: false,
		error: function(XMLHttpRequest, textStatus, errorThrown) {
			more.html('<i class="fa fa-exclamation-triangle" style="font-size:1.5em;"></i>&nbsp;エラーが発生しました');
			more.attr("onClick", "return false;");
		},
		success: function(res, status, XMLHttpRequest) {
			if( res.found > 0 ){
				var insertData = '';
				res.data.forEach(function(val, index, ar){
					if( defineNotLoginParams['view'] === 'audio'){
						var appendClassColor = '';
						if( val.noJacket === 1 ){
							appendClassColor = val.imageColor;
						}
						var lyric = '';
						if( val.hasLyric === 1){
							lyric = '<span class="label_lyric_s"></span>';
						}
						insertData = '<li><a class="thumb-music-'+val.cardType+' '+val.cardResize+' '+ appendClassColor +' " href="/t/'+val.shortContentId+'?f='+res.from+'" style="background-image:url('+val.jacketUrl+');">'+ lyric +'</a><h4 class="rel-works-title">'+val.title+'</h4><p class="rel-works-author">by '+val.author+'</p></li>';
					}else if( defineNotLoginParams['view'] === 'image'){
						insertData = '<li><a href="/t/'+val.shortContentId+'?f='+res.from+'" class="thumb-ill" style="background-image:url(' + val.url + ');"></a><h4 class="rel-works-title">' + val.title + '</h4><p class="rel-works-author">by ' + val.author + '</p></li>'
					}else if( defineNotLoginParams['view'] === 'text'){
						insertData = '<li><a class="i_text" href="/t/'+val.shortContentId+'?f='+res.from+'"><div><p class="title">'+val.title+'</p><p class="opening">'+val.txt+'</p></div></a><h4 class="rel-works-title">'+val.title+'</h4><p class="rel-works-author">by '+val.author+'</p></li>';
					}else if( defineNotLoginParams['view'] === '3dm'){
						insertData = '<li><a href="'+val.shortContentId+'?f='+res.from+'" class="thumb-ill" style="background-image:url(' + val.url + ');"><span class="label3dm_n"></span></a><h4 class="rel-works-title">'+val.title+'</h4><p class="rel-works-author">by '+val.author+'</p></li>';
					}
					$('#recommendBox').append(insertData);
				});
				span.html(now+res.found);
				more.remove();
			}else{
				//	見つからなかったらイベントを消す
				more.html('<i class="fa fa-exclamation-circle" style="font-size:1.5em;"></i>&nbsp;これ以上ありません');
				more.attr("onClick", "return false;");
			}
			processingRecommendMore = false;
		}
	});
}
